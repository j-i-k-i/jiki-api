#!/usr/bin/env ruby

require 'bundler/setup'
require 'jiki-config'
require 'tempfile'
require 'fileutils'

puts "=== Seeding Test Videos to LocalStack S3 ==="
puts ""

bucket = Jiki.config.s3_bucket_video_production
puts "Bucket: #{bucket}"
puts ""

# Check LocalStack is running
print "Checking LocalStack S3... "
begin
  Jiki.s3_client.head_bucket(bucket: bucket)
  puts "✓"
rescue StandardError => e
  puts "✗"
  puts "Error: Cannot access S3 bucket '#{bucket}'"
  puts "Make sure LocalStack is running: bin/dev"
  puts "Error details: #{e.message}"
  exit 1
end

# Create simple test videos using FFmpeg
# These are just colored frames - perfect for testing merge functionality
def create_test_video(color, duration, output_path)
  # Create a simple colored video using FFmpeg
  # Format: 5 seconds, 1280x720, 30fps, H.264 codec
  cmd = [
    "ffmpeg",
    "-f", "lavfi",
    "-i", "color=c=#{color}:s=1280x720:d=#{duration}:r=30",
    "-c:v", "libx264",
    "-pix_fmt", "yuv420p",
    "-y", # Overwrite output file
    output_path,
    "-loglevel", "error" # Only show errors
  ]

  system(*cmd)
end

# Check if ffmpeg is available
unless system("which ffmpeg > /dev/null 2>&1")
  puts "Warning: ffmpeg not found in PATH"
  puts "To create test videos, install ffmpeg:"
  puts "  brew install ffmpeg"
  puts ""
  puts "Skipping test video creation. You can manually upload test videos to:"
  puts "  s3://#{bucket}/test-assets/"
  exit 0
end

Dir.mktmpdir do |tmpdir|
  videos = [
    { name: "video1.mp4", color: "blue", duration: 3 },
    { name: "video2.mp4", color: "red", duration: 3 }
  ]

  videos.each do |video_info|
    print "Creating #{video_info[:name]} (#{video_info[:color]}, #{video_info[:duration]}s)... "

    local_path = File.join(tmpdir, video_info[:name])
    create_test_video(video_info[:color], video_info[:duration], local_path)

    if File.exist?(local_path)
      puts "✓"

      # Upload to S3
      s3_key = "test-assets/#{video_info[:name]}"
      print "  Uploading to s3://#{bucket}/#{s3_key}... "

      Jiki.s3_client.put_object(
        bucket: bucket,
        key: s3_key,
        body: File.read(local_path),
        content_type: 'video/mp4'
      )

      puts "✓ (#{File.size(local_path) / 1024}KB)"
    else
      puts "✗"
      puts "  Error: Failed to create test video"
    end
  end
end

puts ""
puts "=== Test Videos Ready ==="
puts ""
puts "Videos uploaded to:"
puts "  s3://#{bucket}/test-assets/video1.mp4 (blue, 3s)"
puts "  s3://#{bucket}/test-assets/video2.mp4 (red, 3s)"
puts ""
puts "You can now run the test-merge pipeline:"
puts "  bin/rails runner \"$(cat <<'RUBY'"
puts "    # Load pipeline from seed"
puts "    # Execute merge node"
puts "    # Check result"
puts "  RUBY"
puts "  )\""
puts ""
