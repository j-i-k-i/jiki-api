#!/usr/bin/env bash

if ! command -v hivemind &> /dev/null; then
  echo "Error: hivemind not found. Install with: brew install hivemind"
  exit 1
fi

if [ ! -f Procfile.dev ]; then
  echo "Error: Procfile.dev not found"
  exit 1
fi

# Start LocalStack (stop existing containers first)
echo "Starting LocalStack..."
EXISTING_CONTAINER=$(docker ps -aq --filter "publish=3065")
if [ -n "$EXISTING_CONTAINER" ]; then
  echo "Stopping existing LocalStack container(s)..."
  docker stop $EXISTING_CONTAINER > /dev/null 2>&1
  docker rm $EXISTING_CONTAINER > /dev/null 2>&1
fi
docker run -dp 3067:8080 -p 3065:4566 -p 3066:4566 --name localstack-jiki $(jq -r '.localstack' .dockerimages.json)

# Initialize LocalStack (create S3 buckets)
echo "Initializing LocalStack..."
bin/init-localstack

hivemind Procfile.dev
